<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <title>IAQ Monitor</title>

  <link rel="manifest" href="manifest.json">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; }
    #root { min-height: 100vh; padding: 16px; }
    button { cursor: pointer; }
    input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 500; }
    .card { background: white; border-radius: 16px; padding: 20px; margin: 16px auto; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn { background: #667eea; color: white; border: none; border-radius: 8px; padding: 10px 20px; font-size: 16px; transition: background 0.3s; margin: 4px; }
    .btn:hover { background: #5568d3; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
    .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const IAQ_LEVELS = [
      { value: 50, label: 'Excellent', color: '#4CAF50' },
      { value: 100, label: 'Good', color: '#8BC34A' },
      { value: 150, label: 'Lightly Polluted', color: '#CDDC39' },
      { value: 200, label: 'Moderately Polluted', color: '#FFC107' },
      { value: 250, label: 'Heavily Polluted', color: '#FF9800' },
      { value: 350, label: 'Severely Polluted', color: '#F44336' },
      { value: 500, label: 'Extremely Polluted', color: '#B71C1C' }
    ];

    function App() {
      const [deviceIp, setDeviceIp] = useState('192.168.1.100');
      const [isConnected, setIsConnected] = useState(false);
      const [sensorData, setSensorData] = useState(null);
      const [currentLevel, setCurrentLevel] = useState(null);
      const [alarmEnabled, setAlarmEnabled] = useState(false);
      const [alarmThreshold, setAlarmThreshold] = useState('Lightly Polluted');
      const [isAlarming, setIsAlarming] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [voiceEnabled, setVoiceEnabled] = useState(false);
      const [emailEnabled, setEmailEnabled] = useState(false);
      const [emailRecipient, setEmailRecipient] = useState('');
      const [emailjsPublicKey, setEmailjsPublicKey] = useState('');
      const [emailjsServiceId, setEmailjsServiceId] = useState('');
      const [emailjsTemplateId, setEmailjsTemplateId] = useState('');
      const [refreshInterval, setRefreshInterval] = useState(5000);
      const [error, setError] = useState(null);
      const [history, setHistory] = useState([]);
      const [lastAlertTime, setLastAlertTime] = useState(null);
      const [showHistory, setShowHistory] = useState(false);
      const [availableVoices, setAvailableVoices] = useState([]);
      const [selectedVoice, setSelectedVoice] = useState('');
      const [voiceRate, setVoiceRate] = useState(1);
      const [voicePitch, setVoicePitch] = useState(1);
      const [alertMessage, setAlertMessage] = useState('Warning! Air quality is {level}. Current IAQ is {iaq}.');
      
      const alarmSentRef = useRef(false);

      const getLevel = (iaq) => {
        if (!iaq && iaq !== 0) return IAQ_LEVELS[0];
        for (let i = IAQ_LEVELS.length - 1; i >= 0; i--) {
          if (iaq > IAQ_LEVELS[i].value) return IAQ_LEVELS[i + 1] || IAQ_LEVELS[i];
        }
        return IAQ_LEVELS[0];
      };

      const speak = (msg) => {
        if ('speechSynthesis' in window) {
          const u = new SpeechSynthesisUtterance(msg);
          
          // Use selected voice if available
          if (selectedVoice) {
            const voice = availableVoices.find(v => v.name === selectedVoice);
            if (voice) u.voice = voice;
          }
          
          u.rate = voiceRate;
          u.pitch = voicePitch;
          window.speechSynthesis.speak(u);
        }
      };

      const sendEmail = (recipient, level, value, serviceId, templateId) => {
        if (!recipient || !serviceId || !templateId) return;
        if (typeof emailjs !== 'undefined') {
          emailjs.send(serviceId, templateId, {
            to_email: recipient,
            subject: "Air Quality Alert",
            message: `IAQ ${value.toFixed(1)} - ${level.label}`
          }).then(() => console.log("Email sent")).catch(console.error);
        }
      };

      const checkAlarm = (level, data) => {
        if (!alarmEnabled) {
          setIsAlarming(false);
          alarmSentRef.current = false;
          return;
        }

        const tIdx = IAQ_LEVELS.findIndex(l => l.label === alarmThreshold);
        const cIdx = IAQ_LEVELS.findIndex(l => l.label === level.label);
        
        if (cIdx >= tIdx) {
          if (!alarmSentRef.current) {
            console.log('Triggering alarm!', { level: level.label, iaq: data.iaq });
            setIsAlarming(true);
            alarmSentRef.current = true;
            
            // Vibration
            if (navigator.vibrate) {
              navigator.vibrate([200, 100, 200]);
            }
            
            // Voice alert
            if (voiceEnabled) {
              const message = alertMessage
                .replace('{level}', level.label)
                .replace('{iaq}', data.iaq.toFixed(0))
                .replace('{temp}', data.temperature.toFixed(1))
                .replace('{humidity}', data.humidity.toFixed(1));
              console.log('Speaking message:', message);
              speak(message);
            }
            
            // Email alert
            if (emailEnabled && emailjsPublicKey && emailjsServiceId && emailjsTemplateId) {
              sendEmail(emailRecipient, level, data.iaq, emailjsServiceId, emailjsTemplateId);
              setLastAlertTime(new Date().toLocaleTimeString());
            }
          }
        } else {
          setIsAlarming(false);
          alarmSentRef.current = false;
        }
      };

      const fetchData = async () => {
        try {
          const res = await fetch(`http://${deviceIp}/readings`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          
          setSensorData(data);
          const level = getLevel(data.iaq);
          setCurrentLevel(level);
          setIsConnected(true);
          setError(null);
          
          setHistory(prev => [{
            timestamp: new Date().toLocaleTimeString(),
            iaq: data.iaq,
            level: level.label,
            temp: data.temperature,
            humidity: data.humidity
          }, ...prev].slice(0, 20));
          
          checkAlarm(level, data);
        } catch (err) {
          setError(`Connection failed: ${err.message}`);
          setIsConnected(false);
        }
      };

      useEffect(() => {
        fetchData();
        const interval = setInterval(fetchData, refreshInterval);
        return () => clearInterval(interval);
      }, [deviceIp, refreshInterval]);

      useEffect(() => {
        if (emailjsPublicKey && typeof emailjs !== 'undefined') {
          emailjs.init(emailjsPublicKey);
        }
      }, [emailjsPublicKey]);

      // Load available voices
      useEffect(() => {
        const loadVoices = () => {
          const voices = window.speechSynthesis.getVoices();
          setAvailableVoices(voices);
          
          // Set default voice if none selected
          if (!selectedVoice && voices.length > 0) {
            // Try to find English voice first
            const englishVoice = voices.find(v => v.lang.startsWith('en'));
            setSelectedVoice(englishVoice ? englishVoice.name : voices[0].name);
          }
        };

        loadVoices();
        
        // Chrome loads voices asynchronously
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
          window.speechSynthesis.onvoiceschanged = loadVoices;
        }
      }, []);

      return (
        <div>
          <h1 style={{ color: 'white', textAlign: 'center', marginBottom: 16, fontSize: 28 }}>
            üå°Ô∏è IAQ Monitor
          </h1>

          <div className="card" style={{ textAlign: 'center', padding: 12 }}>
            <span className="status-dot" style={{ background: isConnected ? '#4CAF50' : '#F44336' }}></span>
            <span style={{ fontSize: 14 }}>
              {isConnected ? `Connected to ${deviceIp}` : 'Disconnected'}
            </span>
          </div>

          {error && (
            <div className="card" style={{ background: '#FFF3CD', color: '#856404', padding: 12 }}>
              ‚ö†Ô∏è {error}
            </div>
          )}

          {sensorData && (
            <div className="card" style={{ textAlign: 'center' }}>
              <div style={{ fontSize: 64, fontWeight: 'bold', color: currentLevel.color, marginBottom: 8 }}>
                {sensorData.iaq.toFixed(0)}
              </div>
              <div style={{ fontSize: 24, fontWeight: 'bold', color: currentLevel.color, marginBottom: 16 }}>
                {currentLevel.label}
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-around', fontSize: 18, color: '#666' }}>
                <div>üå°Ô∏è {sensorData.temperature.toFixed(1)}¬∞C</div>
                <div>üíß {sensorData.humidity.toFixed(1)}%</div>
              </div>
            </div>
          )}

          {isAlarming && (
            <div className="card" style={{
              background: '#F44336', color: 'white', textAlign: 'center', animation: 'pulse 1s infinite'
            }}>
              <div style={{ fontSize: 48 }}>‚ö†Ô∏è</div>
              <div style={{ fontSize: 20, fontWeight: 'bold' }}>Air Quality Alert!</div>
              <div>{currentLevel?.label}</div>
              {lastAlertTime && <div style={{ fontSize: 12, marginTop: 8 }}>Last alert: {lastAlertTime}</div>}
            </div>
          )}

          <div style={{ textAlign: 'center', marginTop: 16 }}>
            <button onClick={fetchData} className="btn">
              üîÑ Refresh
            </button>
            <button onClick={() => setShowSettings(!showSettings)} className="btn">
              ‚öôÔ∏è {showSettings ? 'Close' : 'Settings'}
            </button>
            <button onClick={() => setShowHistory(!showHistory)} className="btn">
              üìä {showHistory ? 'Hide' : 'History'}
            </button>
          </div>

          {showHistory && history.length > 0 && (
            <div className="card">
              <h3 style={{ marginBottom: 12 }}>Reading History</h3>
              <div style={{ maxHeight: 300, overflow: 'auto' }}>
                {history.map((item, idx) => (
                  <div key={idx} className="history-item">
                    <span style={{ fontSize: 12, color: '#666' }}>{item.timestamp}</span>
                    <span style={{ fontWeight: 'bold' }}>IAQ: {item.iaq.toFixed(0)}</span>
                    <span style={{ fontSize: 12, color: getLevel(item.iaq).color }}>{item.level}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {showSettings && (
            <div className="card">
              <h2 style={{ marginBottom: 16 }}>‚öôÔ∏è Settings</h2>

              <h3 style={{ marginTop: 16, marginBottom: 8, fontSize: 18 }}>Device Connection</h3>
              <label>Device IP Address</label>
              <input 
                type="text" 
                value={deviceIp} 
                onChange={(e) => setDeviceIp(e.target.value)}
                placeholder="192.168.1.100"
                style={{ width: '100%' }} 
              />

              <label>Refresh Interval (ms)</label>
              <input 
                type="number" 
                value={refreshInterval} 
                onChange={(e) => setRefreshInterval(parseInt(e.target.value) || 5000)}
                min="1000"
                step="1000"
                style={{ width: '100%' }} 
              />

              <h3 style={{ marginTop: 16, marginBottom: 8, fontSize: 18 }}>Alarm Settings</h3>
              
              <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                <input 
                  type="checkbox" 
                  checked={alarmEnabled} 
                  onChange={(e) => setAlarmEnabled(e.target.checked)}
                  style={{ marginRight: 8 }}
                /> 
                Enable Alarm System
              </label>

              <label>Alarm Threshold</label>
              <select 
                value={alarmThreshold} 
                onChange={(e) => setAlarmThreshold(e.target.value)} 
                style={{ width: '100%' }}
                disabled={!alarmEnabled}
              >
                {IAQ_LEVELS.slice(2).map(l => <option key={l.label} value={l.label}>{l.label}</option>)}
              </select>

              <div style={{ marginTop: 12 }}>
                <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                  <input 
                    type="checkbox" 
                    checked={voiceEnabled} 
                    onChange={(e) => setVoiceEnabled(e.target.checked)}
                    style={{ marginRight: 8 }}
                    disabled={!alarmEnabled}
                  /> 
                  Voice Alerts (Text-to-Speech)
                </label>
              </div>

              {voiceEnabled && (
                <div style={{ marginTop: 8, paddingLeft: 24, borderLeft: '3px solid #667eea' }}>
                  <label>Alert Message Template</label>
                  <textarea 
                    value={alertMessage} 
                    onChange={(e) => setAlertMessage(e.target.value)}
                    placeholder="Warning! Air quality is {level}. Current IAQ is {iaq}."
                    style={{ width: '100%', minHeight: 60, padding: 8, border: '1px solid #ddd', borderRadius: 4, fontFamily: 'inherit' }}
                    disabled={!alarmEnabled}
                  />
                  <div style={{ fontSize: 12, color: '#666', marginTop: 4, marginBottom: 8 }}>
                    üí° Available placeholders: <code>{'{level}'}</code>, <code>{'{iaq}'}</code>, <code>{'{temp}'}</code>, <code>{'{humidity}'}</code>
                  </div>

                  <label>Voice Selection</label>
                  <select 
                    value={selectedVoice} 
                    onChange={(e) => setSelectedVoice(e.target.value)} 
                    style={{ width: '100%', marginBottom: 8 }}
                    disabled={!alarmEnabled}
                  >
                    {availableVoices.map((voice, idx) => (
                      <option key={idx} value={voice.name}>
                        {voice.name} ({voice.lang})
                      </option>
                    ))}
                  </select>

                  <label>Speech Rate: {voiceRate.toFixed(1)}x</label>
                  <input 
                    type="range" 
                    min="0.5" 
                    max="2" 
                    step="0.1"
                    value={voiceRate} 
                    onChange={(e) => setVoiceRate(parseFloat(e.target.value))}
                    style={{ width: '100%' }}
                    disabled={!alarmEnabled}
                  />

                  <label>Speech Pitch: {voicePitch.toFixed(1)}</label>
                  <input 
                    type="range" 
                    min="0.5" 
                    max="2" 
                    step="0.1"
                    value={voicePitch} 
                    onChange={(e) => setVoicePitch(parseFloat(e.target.value))}
                    style={{ width: '100%' }}
                    disabled={!alarmEnabled}
                  />

                  <button 
                    onClick={() => {
                      const testMsg = alertMessage
                        .replace('{level}', 'Good')
                        .replace('{iaq}', '75')
                        .replace('{temp}', '22.5')
                        .replace('{humidity}', '45.0');
                      speak(testMsg);
                    }}
                    className="btn"
                    style={{ width: '100%', marginTop: 8, fontSize: 14 }}
                    disabled={!alarmEnabled}
                  >
                    üîä Test Voice
                  </button>
                </div>
              )}

              <h3 style={{ marginTop: 16, marginBottom: 8, fontSize: 18 }}>Email/SMS Notifications</h3>
              
              <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                <input 
                  type="checkbox" 
                  checked={emailEnabled} 
                  onChange={(e) => setEmailEnabled(e.target.checked)}
                  style={{ marginRight: 8 }}
                  disabled={!alarmEnabled}
                /> 
                Enable Email/SMS Alerts
              </label>

              {emailEnabled && (
                <div>
                  <label>EmailJS Public Key</label>
                  <input 
                    type="text" 
                    value={emailjsPublicKey} 
                    onChange={(e) => setEmailjsPublicKey(e.target.value)}
                    placeholder="Your EmailJS public key"
                    style={{ width: '100%' }} 
                  />

                  <label>EmailJS Service ID</label>
                  <input 
                    type="text" 
                    value={emailjsServiceId} 
                    onChange={(e) => setEmailjsServiceId(e.target.value)}
                    placeholder="service_xxxxxxx"
                    style={{ width: '100%' }} 
                  />

                  <label>EmailJS Template ID</label>
                  <input 
                    type="text" 
                    value={emailjsTemplateId} 
                    onChange={(e) => setEmailjsTemplateId(e.target.value)}
                    placeholder="template_xxxxxxx"
                    style={{ width: '100%' }} 
                  />

                  <label>Recipient Email/Phone</label>
                  <input 
                    type="email" 
                    value={emailRecipient} 
                    onChange={(e) => setEmailRecipient(e.target.value)}
                    placeholder="you@example.com"
                    style={{ width: '100%' }} 
                  />
                  
                  <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
                    üí° For SMS, use your carrier's email-to-SMS gateway
                  </div>
                </div>
              )}

              <div style={{ marginTop: 16, padding: 12, background: '#E3F2FD', borderRadius: 8, fontSize: 14 }}>
                <strong>‚ÑπÔ∏è Quick Guide:</strong>
                <ul style={{ marginLeft: 20, marginTop: 8 }}>
                  <li>Set your sensor device's IP address</li>
                  <li>Choose alarm threshold level</li>
                  <li>Enable voice or email alerts</li>
                  <li>For EmailJS: Sign up at emailjs.com</li>
                </ul>
              </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>